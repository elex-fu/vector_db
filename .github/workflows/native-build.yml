name: Native Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'native/**'
      - '.github/workflows/native-build.yml'
      - 'src/main/java/com/vectordb/jni/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'native/**'
      - '.github/workflows/native-build.yml'
      - 'src/main/java/com/vectordb/jni/**'

env:
  CMAKE_BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU (for ARM64)
      if: matrix.arch == 'arm64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: native/build
        key: ${{ runner.os }}-${{ matrix.arch }}-cmake-${{ hashFiles('native/CMakeLists.txt', 'native/**/*.cpp', 'native/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-cmake-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ googletest

    - name: Configure CMake
      run: |
        cd native
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON

    - name: Build
      run: |
        cd native/build
        make -j$(nproc)

    - name: Test
      run: |
        cd native/build
        ctest --output-on-failure --parallel $(nproc)

    - name: Upload library
      uses: actions/upload-artifact@v4
      with:
        name: libvectordb-linux-${{ matrix.arch }}
        path: native/build/libvectordb.so*
        retention-days: 7

  build-macos-intel:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: native/build
        key: ${{ runner.os }}-intel-cmake-${{ hashFiles('native/CMakeLists.txt', 'native/**/*.cpp', 'native/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-intel-cmake-

    - name: Install dependencies
      run: |
        brew install cmake googletest

    - name: Configure CMake
      run: |
        cd native
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON

    - name: Build
      run: |
        cd native/build
        make -j$(sysctl -n hw.ncpu)

    - name: Test
      run: |
        cd native/build
        ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)

    - name: Upload library
      uses: actions/upload-artifact@v4
      with:
        name: libvectordb-macos-x86_64
        path: native/build/libvectordb*.dylib
        retention-days: 7

  build-macos-arm64:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: native/build
        key: ${{ runner.os }}-arm64-cmake-${{ hashFiles('native/CMakeLists.txt', 'native/**/*.cpp', 'native/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-arm64-cmake-

    - name: Install dependencies
      run: |
        brew install cmake googletest

    - name: Configure CMake
      run: |
        cd native
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON

    - name: Build
      run: |
        cd native/build
        make -j$(sysctl -n hw.ncpu)

    - name: Test
      run: |
        cd native/build
        ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)

    - name: Upload library
      uses: actions/upload-artifact@v4
      with:
        name: libvectordb-macos-arm64
        path: native/build/libvectordb*.dylib
        retention-days: 7

  build-java:
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Download all native libraries
      uses: actions/download-artifact@v4
      with:
        path: native-libraries
        pattern: libvectordb-*

    - name: Organize native libraries
      run: |
        mkdir -p src/main/resources/native/linux-x86_64
        mkdir -p src/main/resources/native/linux-arm64
        mkdir -p src/main/resources/native/macos-x86_64
        mkdir -p src/main/resources/native/macos-arm64

        cp native-libraries/libvectordb-linux-x86_64/libvectordb.so* src/main/resources/native/linux-x86_64/ 2>/dev/null || true
        cp native-libraries/libvectordb-linux-arm64/libvectordb.so* src/main/resources/native/linux-arm64/ 2>/dev/null || true
        cp native-libraries/libvectordb-macos-x86_64/libvectordb*.dylib src/main/resources/native/macos-x86_64/ 2>/dev/null || true
        cp native-libraries/libvectordb-macos-arm64/libvectordb*.dylib src/main/resources/native/macos-arm64/ 2>/dev/null || true

        echo "Native libraries organized:"
        find src/main/resources/native -type f

    - name: Build with Maven
      run: mvn clean compile -DskipTests

    - name: Run Java tests
      run: mvn test

  performance-test:
    runs-on: ubuntu-latest
    needs: build-java
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Download library
      uses: actions/download-artifact@v4
      with:
        name: libvectordb-linux-x86_64
        path: native/build/

    - name: Run performance tests
      run: |
        cd native/build
        chmod +x libvectordb.so
        mkdir -p ../../src/main/resources/native/linux-x86_64
        cp libvectordb.so* ../../src/main/resources/native/linux-x86_64/
        cd ../..
        mvn test -Pbenchmark -Dtest=NativeDistanceBenchmark -DfailIfNoTests=false

  benchmark-report:
    runs-on: ubuntu-latest
    needs: performance-test
    steps:
    - name: Generate benchmark report
      run: |
        echo "## Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Distance Calculation Speedup" >> $GITHUB_STEP_SUMMARY
        echo "- Target: 5x+ vs Java implementation" >> $GITHUB_STEP_SUMMARY
        echo "- Status: See test output above" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Matrix" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | x86_64 | Built |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | ARM64 | Built |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | x86_64 | Built |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | ARM64 | Built |" >> $GITHUB_STEP_SUMMARY
